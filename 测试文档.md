### 单元测试

单元测试基于基于 **Golang** 原生的 **testing** 包 和 **Testify** 断言库，结合 Gin 框架 和 GORM 数据库框架，通过为每个函数配备一个单元测试函数，遍历其可能遇到的各种情况，实现了对 Controllers 中的每个函数的单元测试，最终达到 **80.5%** 的总体行覆盖率。导出的各函数行覆盖率如下

| 类别                     | 函数                           | 行覆盖率 |
| ------------------------ | ------------------------------ | -------- |
| **News Functions**       | NewNewsController              | 100.0%   |
|                          | CreateDraft                    | 92.0%    |
|                          | UploadImage                    | 84.6%    |
|                          | uploadImage                    | 84.2%    |
|                          | createFile                     | 100.0%   |
|                          | ConvertDraftToNews             | 66.7%    |
|                          | UpdateDraft                    | 87.5%    |
|                          | DeleteDraft                    | 82.8%    |
|                          | DeleteNews                     | 75.7%    |
|                          | deleteLocalFile                | 66.7%    |
|                          | GetMyNews                      | 83.3%    |
|                          | GetMyDrafts                    | 83.3%    |
|                          | PreviewNews                    | 100.0%   |
|                          | PreviewDrafts                  | 100.0%   |
|                          | GetNewsDetails                 | 75.9%    |
|                          | fetchUserLikedCommentMap       | 71.4%    |
|                          | GetDraftDetails                | 88.9%    |
|                          | GetNewsByViewCount             | 88.2%    |
|                          | GetNewsByLikeCount             | 88.2%    |
|                          | GetNewsByUploadTime            | 88.2%    |
|                          | AddComment                     | 80.0%    |
|                          | LikeComment                    | 83.3%    |
|                          | CancelLikeComment              | 78.8%    |
|                          | DeleteComment                  | 90.9%    |
|                          | deleteCommentRecursive         | 88.9%    |
|                          | LikeNews                       | 83.0%    |
|                          | CancelLikeNews                 | 78.4%    |
|                          | FavoriteNews                   | 83.0%    |
|                          | CancelFavoriteNews             | 78.4%    |
|                          | DislikeNews                    | 83.0%    |
|                          | CancelDislikeNews              | 78.4%    |
|                          | ViewNews                       | 65.6%    |
|                          | GetUserNewsStatus              | 93.8%    |
|                          | SearchNews                     | 100.0%   |
| **User Functions**       | NewUserController              | 100.0%   |
|                          | WeChatAuth                     | 83.8%    |
|                          | SetNickname                    | 89.5%    |
|                          | SetAvatar                      | 82.9%    |
|                          | RefreshTokenHandler            | 100.0%   |
|                          | LogoutHandler                  | 92.9%    |
|                          | UserBasicDetails               | 100.0%   |
|                          | GetMyFavoritedNews             | 85.7%    |
|                          | GetMyLikedNews                 | 85.7%    |
|                          | GetMyViewedNews                | 85.7%    |
|                          | GetUserProfile                 | 100.0%   |
| **Family Functions**     | NewFamilyController            | 100.0%   |
|                          | getStartOfDay                  | 100.0%   |
|                          | truncateToOneDecimal           | 100.0%   |
|                          | GetDesiredDishes               | 90.9%    |
|                          | SearchFamily                   | 87.5%    |
|                          | PendingFamilyDetails           | 87.5%    |
|                          | FamilyDetails                  | 86.8%    |
|                          | JoinFamily                     | 86.7%    |
|                          | AddDesiredDish                 | 86.2%    |
|                          | RejectJoinFamily               | 85.7%    |
|                          | SetMember                      | 85.5%    |
|                          | DeleteDesiredDish              | 88.5%    |
|                          | AdmitJoinFamily                | 82.1%    |
|                          | SetAdmin                       | 81.8%    |
|                          | CreateFamily                   | 77.8%    |
|                          | DeleteFamilyMember             | 75.8%    |
|                          | BreakFamily                    | 73.0%    |
|                          | LeaveFamily                    | 68.4%    |
|                          | CancelJoinFamily               | 65.2%    |
| **Food Functions**       | NewFoodController              | 100.0%   |
|                          | GetFoodNames                   | 72.7%    |
|                          | CalculateNutritionAndEmission  | 100.0%   |
| **Preference Functions** | getProjectRoot                 | 100.0%   |
|                          | DeleteFoodPreference           | 100.0%   |
|                          | AddFoodPreference              | 91.3%    |
|                          | GetUserPreferences             | 83.3%    |
|                          | DeleteDislikedFoodPreference   | 82.4%    |
|                          | GetUserDislikedPreferences     | 82.4%    |
|                          | AddDislikedFoodPreference      | 78.6%    |
|                          | validatePreference             | 66.7%    |
| **Nutrition Functions**  | validateDate                   | 100.0%   |
|                          | calculateTimeRange             | 100.0%   |
|                          | validateUserShares             | 92.0%    |
|                          | GetActualNutrition             | 85.4%    |
|                          | GetCarbonGoals                 | 84.6%    |
|                          | GetCarbonIntakes               | 84.6%    |
|                          | GetNutritionGoals              | 82.8%    |
|                          | SetSharedNutritionCarbonIntake | 73.2%    |
|                          | SetNutritionGoals              | 73.1%    |
|                          | SetCarbonGoals                 | 71.7%    |
| **Recommendation**       | intersection                   | 100.0%   |
|                          | SetUserSelectedFoods           | 100.0%   |
|                          | sample                         | 90.5%    |
|                          | loadFoodPreferences            | 84.2%    |
|                          | union                          | 66.7%    |
|                          | RecommendIngredients           | 56.6%    |
|                          | RecommendRecipes               | 53.1%    |

### 自动化测试配置

在我们的 Go 项目中，单元测试配置为在构建过程中自动执行。通过引入 go test 和相关工具，我们实现了高效的自动化测试流程。通过执行

```bash
$ go test ./controllers
```

即可执行全部单元测试, 并且可以结合 -cover 等参数查看覆盖率等信息。

### 性能测试报告

#### 概述

测试工具：apifox

测试目的：评估在并发用户负载下的性能表现

本次性能测试覆盖以下模块：

1. **核心接口模块**：处理食物数据与营养计算的请求。
2. **用户偏好模块**：用户偏好与不喜好管理接口。
3. **目标设置模块**：营养及碳排放目标的设置与获取操作。
4. **共享数据模块**：共享营养与碳排放相关接口。
5. **推荐模块**：用户选择食品、推荐食材与食谱接口。

测试目标是评估各模块接口在不同负载场景下的性能表现及稳定性。

#### 测试结果

| 测试模块     | 总请求数 | 每秒请求数 (平均) | 平均响应时间 (ms) | 请求失败率 |
| ------------ | -------- | ----------------- | ----------------- | ---------- |
| 食物接口模块 | 2,279    | 34.00             | 48                | 0.00%      |
| 用户偏好模块 | 2817     | 46.95             | 44                | 0.00%      |
| 目标设置模块 | 4,086    | 61.33             | 49                | 0.00%      |
| 共享数据模块 | 2,206    | 33.00             | 218               | 0.00%      |
| 推荐模块     | 2,899    | 43.39             | 82                | 0.00%      |



#### 核心接口测试详情

| 接口名称              | 总请求数 | 每秒请求数 | 平均响应时间 (ms) | 最小响应时间 (ms) | 最大响应时间 (ms) | 90% 响应时间 (ms) | 失败率 |
| --------------------- | -------- | ---------- | ----------------- | ----------------- | ----------------- | ----------------- | ------ |
| GET /foods/names      | 1,140    | 17.01      | 57                | 32                | 121               | 84                | 0.00%  |
| POST /foods/calculate | 1,139    | 16.99      | 39                | 31                | 182               | 44                | 0.00%  |

**分析**：

- `GET /foods/names` 接口存在响应时间波动，90% 请求时间有 84 ms。可能是因为数据库规模庞大，返回数据过多原因导致的。
- `POST /foods/calculate` 接口响应性能稳定，90% 请求时间低于 44 ms，最大响应时间为 182 ms。



#### 用户偏好接口测试详情

| 接口名称                     | 总请求数 | 每秒请求数 | 平均响应时间 (ms) | 最小响应时间 (ms) | 最大响应时间 (ms) | 90% 响应时间 (ms) | 失败率 |
| ---------------------------- | -------- | ---------- | ----------------- | ----------------- | ----------------- | ----------------- | ------ |
| POST /preferences            | 470      | 7.83       | 50                | 43                | 101               | 57                | 0.00%  |
| DELETE /preferences          | 470      | 7.83       | 47                | 41                | 94                | 50                | 0.00%  |
| GET /preferences             | 468      | 7.80       | 37                | 33                | 56                | 39                | 0.00%  |
| POST /disliked_preferences   | 470      | 7.83       | 47                | 42                | 86                | 54                | 0.00%  |
| GET /disliked_preferences    | 469      | 7.82       | 39                | 33                | 104               | 40                | 0.00%  |
| DELETE /disliked_preferences | 470      | 7.83       | 45                | 41                | 66                | 49                | 0.00%  |

**分析**：

- 所有接口的平均响应时间均在 50 ms 以下，且失败率为 0.00%，表现稳定。
- 最大响应时间为 `GET /disliked_preferences` 接口的 104 ms，仍然处于可接受范围。

#### 推荐模块

| 接口名称                      | 总请求数 | 每秒请求数 | 平均响应时间 (ms) | 最小响应时间 (ms) | 最大响应时间 (ms) | 90% 响应时间 (ms) | 失败率 |
| ----------------------------- | -------- | ---------- | ----------------- | ----------------- | ----------------- | ----------------- | ------ |
| `POST /ingredients/set`       | 967      | 14.47      | 62                | 41                | 587               | 82                | 0.00%  |
| `POST /ingredients/recommend` | 966      | 14.46      | 117               | 58                | 579               | 173               | 0.00%  |
| `POST /recipes/recommend`     | 966      | 14.46      | 67                | 40                | 291               | 97                | 0.00%  |

**分析**：

- 食材推荐接口（`POST /ingredients/recommend`）的平均响应时间较高（117 ms），因为推荐算法需要进行重复采样，可能与推荐算法的复杂度有关。
- 用户选择接口和食谱推荐接口的性能较为稳定，最大响应时间分别为 587 ms 和 291 ms。

#### 共享数据模块

| 接口名称                        | 总请求数 | 每秒请求数 | 平均响应时间 (ms) | 最小响应时间 (ms) | 最大响应时间 (ms) | 90% 响应时间 (ms) | 失败率 |
| ------------------------------- | -------- | ---------- | ----------------- | ----------------- | ----------------- | ----------------- | ------ |
| POST /nutrition-carbon/shared   | 737      | 11.03      | 62                | 41                | 703               | 72                | 0.00%  |
| GET /nutrition-carbon/carbon    | 735      | 11.00      | 349               | 36                | 1,371             | 1,069             | 0.00%  |
| GET /nutrition-carbon/nutrition | 734      | 10.98      | 243               | 36                | 1,640             | 590               | 0.00%  |

**分析**：

- `GET /nutrition-carbon/carbon` 和 `GET /nutrition-carbon/nutrition` 的最大响应时间分别为 2,371 ms 和 1,640 ms，表明在高并发情况下可能存在性能瓶颈。原因可能是因为传输的数据过多造成的。

- `POST /nutrition-carbon/shared` 的性能较稳定，90% 请求响应时间在 72 ms 内。

  

#### 目标设置模块

| 接口名称                | 总请求数 | 每秒请求数 | 平均响应时间 (ms) | 最小响应时间 (ms) | 最大响应时间 (ms) | 90% 响应时间 (ms) | 失败率 |
| ----------------------- | -------- | ---------- | ----------------- | ----------------- | ----------------- | ----------------- | ------ |
| `POST /nutrition/goals` | 1,023    | 15.36      | 56                | 39                | 462               | 76                | 0.00%  |
| `GET /nutrition/goals`  | 1,021    | 15.33      | 45                | 34                | 372               | 56                | 0.00%  |



#### 关键观察点

1. 所有模块的成功率都是100%，可靠性强，但是对于一些需要大量数据传输的接口，需要较高的响应时间。
2. 性能瓶颈：
   - 食材推荐接口的平均响应时间（117 ms）相较于其他推荐接口偏高，可能是推荐算法计算时间较长导致。
   - `POST /ingredients/set` 的最大响应时间达到 587 ms，需检查接口逻辑是否存在性能问题。
3. **整体表现**：测试结果表明，系统能够满足大部分业务需求，但推荐模块的某些接口在高负载场景下仍有优化空间。

#### 后续

1. 性能优化: 对于响应时间较⻓的API端点，建议进行更深入的性能分析，以识别和解决可能的瓶颈。
2. 资源监控: 在进行性能测试时监控服务器资源使用情况，如CPU、内存和网络使用情况，以帮助识别性能瓶颈。
3. 扩展性评估: 考虑进行更高负载的测试，以评估服务在极端条件下的表现和扩展需求。

