<template>
  <view class="container">
    <!-- ÊñáÁ´†Ê†áÈ¢ò -->
    <view class="title-input-container">
      <textarea
        v-model="title"
        class="title-input"
        :placeholder="t('putin_title')"
        autoHeight
      ></textarea>
    </view>

    <!-- ÊñáÁ´†ÁÆÄ‰ªã -->
    <view class="description-input-container">
      <textarea
        v-model="description"
        class="description-input"
        :placeholder="t('putin_introduction')"
        autoHeight
      ></textarea>
    </view>

    <!-- È¢ÑËßàÂå∫ -->
    <view class="preview">
      <view v-for="(item, index) in items" :key="index" class="preview-item">
        <view
          class="item-content"
          :style="{ height: item.type === 'image' ? item.itemHeight + 'px' : 'auto' }"
        >
          <textarea
            v-if="item.type === 'text'"
            v-model="item.content"
            class="text-input"
            :placeholder="t('putin_text_placeholder')"
            autoHeight
          ></textarea>

          <!-- ÂõæÁâá‰∏ä‰º†ÂäüËÉΩ -->
          <view v-if="item.type === 'image'">
            <image
              :src="item.content"
              class="image-preview"
              :style="{ height: item.imageHeight + 'px' }"
              @click="handleImageChange(index)"
            />
            <textarea
              v-model="item.imageDescription"
              class="image-description-input"
              :placeholder="t('add_description')"
              autoHeight
            ></textarea>
          </view>

          <!-- Âà†Èô§ÊåâÈíÆÊîπ‰∏∫Â∞èÂõæÊ†á -->
          <button @click="removeItem(index)" class="remove-btn">üóëÔ∏è</button>
        </view>
      </view>
    </view>

    <!-- ÂäüËÉΩÂå∫ -->
    <!-- ÂäüËÉΩÂå∫ -->
    <view class="functions">
      <button v-if="showfunctions" @click="addText" class="function-btn">
        <image src="@/pagesNews/static/addtext.svg" alt="Add Text" class="icon"></image>
      </button>
      <button v-if="showfunctions" @click="addImage" class="function-btn">
        <image src="@/pagesNews/static/addpicture.svg" alt="Add Image" class="icon"></image>
      </button>
      <button v-if="showfunctions" @click="publish" class="push-btn">
        <image src="@/pagesNews/static/share.svg" alt="Publish" class="icon"></image>
      </button>
      <button v-if="showfunctions" @click="saveDraft" class="function-btn">
        <image src="@/pagesNews/static/save.svg" alt="Save" class="icon"></image>
      </button>
	  <button v-if="showfunctions" @click="changefunction" class="function-btn">
	  		<image src="@/pagesNews/static/minus.svg" alt="-" class="icon"></image>
	  </button>
	  <button v-if="hidefunctions" @click="changefunction" class="add-btn">
	  		<image src="@/pagesNews/static/plus.svg" alt="+" class="icon"></image>
	  </button>
    </view>

    <!-- ÂèëÂ∏ÉÁ°ÆËÆ§ÂºπÁ™ó -->
    <view v-if="showModal" class="modal">
        <view class="popup-content">
          <!-- ÊòæÁ§∫‰ΩúËÄÖÂ§¥ÂÉèÂíåÊòµÁß∞ -->
          <view class="popup-header">
            <image :src="authorAvatar" class="avatar" />
            <span class="nickname">{{ authorNickname }}</span>
          </view>
          <view class="popup-footer">
            <button @click="confirmPublish" class="confirm-btn">{{ t('confirm_issue') }}</button>
            <button @click="cancelPublish" class="cancel-btn">{{ t('cancel') }}</button>
          </view>
        </view>
      </view>
	</view>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useI18n } from 'vue-i18n'
import { onHide, onUnload } from '@dcloudio/uni-app'; // ÂØºÂÖ• onUnload
import { useDraftStore } from '../stores/draft';
import { useUserStore } from '../../stores/user'; // ÂºïÂÖ• Pinia Áî®Êà∑Â≠òÂÇ®
const draftStore = useDraftStore();
const userStore = useUserStore();

const BASE_URL = 'http://122.51.231.155:8080';
const BASE_URL_SH = 'http://122.51.231.155';

const authorNickname = computed(() => userStore.user.nickName);
const authorAvatar = computed(() =>
    userStore.user.avatarUrl
        ? `${BASE_URL}/static/${userStore.user.avatarUrl}`
        : '/static/images/index/background_img.jpg'
);
const user_id = computed(() => userStore.user.uid);
const token = computed(() => userStore.user.token);
const { t } = useI18n()

const title = ref('') // ÊñáÁ´†Ê†áÈ¢ò
const description = ref('') // ÊñáÁ´†ÁÆÄ‰ªã
const items = ref([]) // È¢ÑËßàÂå∫ÁöÑÂÜÖÂÆπ
const showModal = ref(false) // ÊéßÂà∂ÂèëÂ∏ÉÁ°ÆËÆ§ÂºπÁ™óÁöÑÊòæÁ§∫‰∏éÂê¶
const showfunctions = ref(true)
const hidefunctions = ref(false)
const PageId = ref(0)//ËçâÁ®øÁºñÂè∑

// Ê∑ªÂä†ÊñáÂ≠ó
const addText = () => {
  items.value.push({ type: 'text', content: '' })
}

const changefunction = () => {
	if(showfunctions.value === true){
		showfunctions.value = false;
		hidefunctions.value = true;
	}
	else{
		showfunctions.value = true;
		hidefunctions.value = false;
	}
}

// Ê∑ªÂä†ÂõæÁâá
const addImage = () => {
  items.value.push({ type: 'image', content: '', itemHeight: 280, imageHeight: 200, imageDescription: '' }) // ÂàùÂßãÂåñÂõæÁâáÈ°π
}

// Âà†Èô§È°πÁõÆ
const removeItem = (index) => {
  items.value.splice(index, 1)
}

// ÂèëÂ∏É
const publish = () => {
  showModal.value = true
}

// Á°ÆËÆ§ÂèëÂ∏É
const confirmPublish = async () => {
  console.log('Á°ÆËÆ§ÂèëÂ∏É');
  try {
    const pageId = await saveDraft(); // Á≠âÂæÖ saveDraft ÂÆåÊàêÂπ∂Ëé∑Âèñ pageId
    console.log('ËçâÁ®ø‰øùÂ≠òÁºñÂè∑:', pageId);

    const pageIdInt = parseInt(pageId, 10); // ËΩ¨Êç¢‰∏∫Êï¥Êï∞
    if (isNaN(pageIdInt)) {
      uni.showToast({
        title: 'Invalid PageId',
        icon: 'none',
        duration: 2000,
      });
      return;
    }

    // Ë∞ÉÁî® API Â∞ÜËçâÁ®øËΩ¨Êç¢‰∏∫Êñ∞Èóª
    uni.request({
      url: `${BASE_URL}/news/convert_draft`, // ËΩ¨Êç¢ËçâÁ®øÁöÑ API Ë∑ØÂæÑ
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token.value}`, // ‰ΩøÁî®ÂΩìÂâç token
        'Content-Type': 'application/json',
      },
      data: {
        draft_id: pageIdInt, // ‰ΩøÁî®ËΩ¨Êç¢ÂêéÁöÑÊï¥Êï∞ PageId
      },
      success: (res) => {
        if (res.data.message === 'Draft converted to news successfully.') {
          uni.showToast({
            title: 'ËçâÁ®øÂ∑≤ÂèëÂ∏É‰∏∫Êñ∞Èóª',
            icon: 'success',
            duration: 2000,
          });
          showModal.value = false; // ÂÖ≥Èó≠ÂºπÁ™ó
        } else {
          uni.showToast({
            title: 'ÂèëÂ∏ÉÂ§±Ë¥•',
            icon: 'none',
            duration: 2000,
          });
          console.error('ÂêéÁ´ØÈîôËØØ‰ø°ÊÅØ:', res.data.message);
        }
      },
      fail: (err) => {
        uni.showToast({
          title: 'ËØ∑Ê±ÇÂ§±Ë¥•',
          icon: 'none',
          duration: 2000,
        });
        console.error('ËØ∑Ê±ÇÂ§±Ë¥•', err);
      }
    });
    showModal.value = false;
  } catch (error) {
    uni.showToast({
      title: '‰øùÂ≠òËçâÁ®øÂ§±Ë¥•ÔºåËØ∑ÈáçËØï',
      icon: 'none',
      duration: 2000,
    });
    console.error('‰øùÂ≠òËçâÁ®øÂ§±Ë¥•:', error);
  }
};



// ÂèñÊ∂àÂèëÂ∏É
const cancelPublish = () => {
  showModal.value = false
}

//‰∏ä‰º†ÂõæÁâá
const uploadImage = (filePath) => {
	console.log(token.value);
  return new Promise((resolve, reject) => {
    uni.uploadFile({
      url: `${BASE_URL}/news/upload_image`, // ‰∏ä‰º†ÂõæÁâáÁöÑ API Âú∞ÂùÄ
      method: 'POST',
      header: {
        "Authorization": `Bearer ${token.value}`, // ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑ Token ÂèòÈáè
        "Content-Type": "application/json", // ËÆæÁΩÆËØ∑Ê±ÇÁ±ªÂûã
      },
      filePath: filePath,
      name: 'image', // form-data ‰∏≠Â≠óÊÆµÂêç
      success: (res) => {
        console.log('‰∏ä‰º†ÂõæÁâáËøîÂõûÁªìÊûú:', res); // ÊâìÂç∞ÂìçÂ∫îÂÜÖÂÆπÁî®‰∫éË∞ÉËØï
        try {
          const data = JSON.parse(res.data); // Ëß£ÊûêËøîÂõûÁöÑ JSON Êï∞ÊçÆ
          if (data.message === 'Image uploaded successfully') {
            resolve(data.path); // ËøîÂõûÂõæÁâáÁõ∏ÂØπË∑ØÂæÑ
			console.log(data.path);
          } else {
            reject(data.error); // ‰∏ä‰º†Â§±Ë¥•ÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØ
          }
        } catch (error) {
          reject(`JSON Ëß£ÊûêÈîôËØØ: ${error.message}`); // Ëß£ÊûêÂ§±Ë¥•Êó∂ÁöÑÈîôËØØÊèêÁ§∫
        }
      },
      fail: (err) => {
        reject(err); // ËØ∑Ê±ÇÂ§±Ë¥•ÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØ
      }
    });
  });
};


const saveDraft = async () => {
  // ÁîüÊàêËçâÁ®øÂØπË±°ÔºåÂåÖÂê´Ê†áÈ¢ò„ÄÅÁÆÄ‰ªã„ÄÅÁªÑ‰ª∂ÂÜÖÂÆπÁ≠â
  const post = {
    title: title.value, // ÊñáÁ´†Ê†áÈ¢ò
    description: description.value, // ÊñáÁ´†ÁÆÄ‰ªã
    components: items.value.map((item, index) => {
      if (item.type === 'text') {
        return { id: index + 1, content: item.content, style: 'text' };
      } else if (item.type === 'image') {
        return { 
          id: index + 1, 
          content: item.content, 
          style: 'image', 
          description: item.imageDescription || '' 
        };
      }
    })
  };

  const data = {
    title: post.title,
    paragraphs: [], // Áî®‰∫éÂ≠òÊîæÊñáÊú¨ÊÆµËêΩ
    images: [], // Áî®‰∫éÂ≠òÊîæÂõæÁâáÈìæÊé•
    image_descriptions: [] // Áî®‰∫éÂ≠òÊîæÂõæÁâáÊèèËø∞
  };

  // ÈªòËÆ§ÁÆÄ‰ªã‰∏∫Á¨¨‰∏Ä‰∏™Ëá™ÁÑ∂ÊÆµ
  data.paragraphs.push(description.value);
  data.images.push(''); // ÂÖàÊ∑ªÂä†‰∏Ä‰∏™Á©∫ÁöÑÂõæÁâáË∑ØÂæÑ
  data.image_descriptions.push('');

  // ‰∏ä‰º†ÊâÄÊúâÂõæÁâáÂπ∂Â°´ÂÖÖÂõæÁâáË∑ØÂæÑ
  const imagePaths = await Promise.all(
    post.components.map((item) => {
      if (item.style === 'image' && item.content) {
        data.paragraphs.push(''); // Ê∑ªÂä†Á©∫ÊÆµËêΩ
        data.images.push(item.content); // ‰øùÂ≠ò‰∏ä‰º†ÂêéÁöÑÂõæÁâáË∑ØÂæÑ
        data.image_descriptions.push(item.description || ''); // ‰øùÂ≠òÂõæÁâáÊèèËø∞
      } else if (item.style === 'text') {
        data.paragraphs.push(item.content || ''); // Ê∑ªÂä†ÊñáÂ≠óÊÆµËêΩ
        data.images.push(''); // Á©∫ÁôΩÂõæÁâáË∑ØÂæÑ
        data.image_descriptions.push(''); // Á©∫ÁôΩÂõæÁâáÊèèËø∞
      }
    })
  );

  return new Promise((resolve, reject) => {
    // Êèê‰∫§ËçâÁ®øÊï∞ÊçÆÂà∞ÊúçÂä°Âô®
    uni.request({
      url: `${BASE_URL}/news/create_draft`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token.value}`,
        'Content-Type': 'application/json',
      },
      data: {
        title: data.title,
        paragraphs: data.paragraphs,
        image_descriptions: data.image_descriptions,
        image_paths: data.images,
      },
      success: (res) => {
        if (res.data.message === 'Draft created successfully.') {
          PageId.value = res.data.draft_id;
          resolve(PageId.value); // ÊàêÂäüÊó∂ËøîÂõû draft_id
		  uni.showToast({
		    title: 'ËçâÁ®øÂ∑≤‰øùÂ≠ò',
		    icon: "fail",
		    duration: 2000,
		  });
        } else {
          reject('‰øùÂ≠òËçâÁ®øÂ§±Ë¥•'); // Â§±Ë¥•Êó∂ÊãíÁªù Promise
        }
      },
      fail: (err) => {
        reject(err); // ËØ∑Ê±ÇÂ§±Ë¥•ÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØ
      }
    });
  });
};



// Â§ÑÁêÜÂõæÁâá‰∏ä‰º†
const handleImageChange = (index) => {
  console.log("Ê≠£Âú®Êõ¥ÊîπÂõæÁâá");

  uni.chooseImage({
    count: 1, // ÈÄâÊã©‰∏ÄÂº†ÂõæÁâá
    sourceType: ['album'], // Âè™‰ªéÁõ∏ÂÜå‰∏≠ÈÄâÊã©
    success: (res) => {
      const imagePath = res.tempFilePaths[0];
      items.value[index].content = imagePath;

      // Ëé∑ÂèñÂõæÁâáÁöÑÂÆΩÈ´òÊØî
      uni.getImageInfo({
        src: imagePath,
        success: (info) => {
          const aspectRatio = info.width / info.height;
          const newHeight = uni.getSystemInfoSync().windowWidth / aspectRatio;
          items.value[index].imageHeight = newHeight;
          items.value[index].itemHeight = newHeight + 80;
        },
        fail: (err) => {
          console.error('Ëé∑ÂèñÂõæÁâá‰ø°ÊÅØÂ§±Ë¥•', err);
        }
      });

      // ‰∏ä‰º†ÂõæÁâáÂà∞ÊúçÂä°Âô®
      uploadImage(imagePath).then((uploadedPath) => {
        // Â∞Ü‰∏ä‰º†ËøîÂõûÁöÑË∑ØÂæÑÊãºÊé•ÊàêÂÆåÊï¥URL
        const fullImageUrl = `${BASE_URL}/static/${uploadedPath}`;
		console.log(fullImageUrl);
        items.value[index].content = fullImageUrl;
      }).catch((error) => {
        console.error('ÂõæÁâá‰∏ä‰º†ÊúçÂä°Âô®Â§±Ë¥•', error);
      });
    },
    fail: (err) => {
      console.error('‰∏ä‰º†ÂõæÁâáÂ§±Ë¥•', err);
    }
  });
};


// Simulate fetching data from backend
onMounted(() => {
  console.log('ËøõÂÖ•Êñ∞ÈóªÂàõ‰ΩúÈ°µ');
});

// Âú®È°µÈù¢Âç∏ËΩΩÊó∂Ëá™Âä®‰øùÂ≠òËçâÁ®ø
onHide(async () => {
  console.log('È°µÈù¢Âç≥Â∞ÜÂç∏ËΩΩÔºåËá™Âä®‰øùÂ≠òËçâÁ®ø');
  try {
    const pageId = await saveDraft();
    console.log('Ëá™Âä®‰øùÂ≠òËçâÁ®øÊàêÂäüÔºåËçâÁ®øÁºñÂè∑:', pageId);
  } catch (error) {
    console.error('Ëá™Âä®‰øùÂ≠òËçâÁ®øÂ§±Ë¥•:', error);
  }
});

onUnLoad(async () => {
  console.log('È°µÈù¢Âç≥Â∞ÜÂç∏ËΩΩÔºåËá™Âä®‰øùÂ≠òËçâÁ®ø');
  try {
    const pageId = await saveDraft();
    console.log('Ëá™Âä®‰øùÂ≠òËçâÁ®øÊàêÂäüÔºåËçâÁ®øÁºñÂè∑:', pageId);
  } catch (error) {
    console.error('Ëá™Âä®‰øùÂ≠òËçâÁ®øÂ§±Ë¥•:', error);
  }
});
</script>

<style scoped>
.container {
  padding: 20px;
}

.title-input-container,
.description-input-container {
  margin-bottom: 20px;
}

.title-input,
.description-input {
  width: 100%;
  padding: 15px;
  font-size: 20px;
  border: 1px solid #ccc;
  border-radius: 5px;
  box-sizing: border-box;
  resize: none; /* Á¶ÅÊ≠¢Áî®Êà∑ÊâãÂä®Ë∞ÉÊï¥Â§ßÂ∞è */
}

.title-input {
  font-size: 24px;
  font-weight: bold;
  min-height: 80px; /* ËÆæÁΩÆÊúÄÂ∞èÈ´òÂ∫¶ */
  max-height: 200px; /* ËÆæÁΩÆÊúÄÂ§ßÈ´òÂ∫¶ */
  overflow: auto; /* Ë∂ÖÂá∫ÈÉ®ÂàÜÂèØÊªöÂä® */
}

.description-input {
  font-size: 16px;
  color: #555;
  min-height: 80px; /* ËÆæÁΩÆÊúÄÂ∞èÈ´òÂ∫¶ */
  max-height: 150px; /* ËÆæÁΩÆÊúÄÂ§ßÈ´òÂ∫¶ */
  overflow: auto; /* Ë∂ÖÂá∫ÈÉ®ÂàÜÂèØÊªöÂä® */
}

.preview {
  margin-bottom: 20px;
}

.preview-item {
  margin-bottom: 15px;
}

.item-content {
  position: relative;
  border: 1px solid #ccc;
  padding: 10px;
  border-radius: 8px;
  box-sizing: border-box;
}

.text-input, {
  width: 100%;
  padding: 10px;
  font-size: 16px;
  border: none;
  outline: none;
  resize: none; /* Á¶ÅÊ≠¢Áî®Êà∑ÊâãÂä®Ë∞ÉÊï¥Â§ßÂ∞è */
  min-height: 80px; /* ËÆæÁΩÆÊúÄÂ∞èÈ´òÂ∫¶ */
  max-height: 200px; /* ËÆæÁΩÆÊúÄÂ§ßÈ´òÂ∫¶ */
  overflow: auto; /* Ë∂ÖÂá∫ÈÉ®ÂàÜÂèØÊªöÂä® */
  padding-right: 30px; /* Ê∑ªÂä†Âè≥ÂÜÖËæπË∑ù‰ª•ÈÅøÂÖçË¶ÜÁõñÂà†Èô§ÊåâÈíÆ */
}

.image-preview {
  width: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.image-description-input {
  width: 100%;
  padding: 8px;
  font-size: 12px;
  border: 1px solid #ccc;
  border-radius: 5px;
  margin-top: 12px; /* Â¢ûÂä†‰∏äËæπË∑ùÔºåÈÅøÂÖç‰∏éÂÖ∂‰ªñÁªÑ‰ª∂ÈáçÂè† */
  box-sizing: border-box;
  min-height: 40px; /* ËÆæÁΩÆÊúÄÂ∞èÈ´òÂ∫¶ */
  max-height: 40px; /* ËÆæÁΩÆÊúÄÂ§ßÈ´òÂ∫¶ */
}

.remove-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  z-index: 2; /* Á°Æ‰øùÂà†Èô§ÊåâÈíÆÂú®ÊúÄ‰∏äÂ±Ç */
}

/* ÂäüËÉΩÂå∫Âõ∫ÂÆöÂ∑¶‰æß */
.functions {
  position: fixed;
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  background-color: rgba(0, 0, 0, 0.5); /* ÂçäÈÄèÊòéËÉåÊôØ */
  padding: 10px;
  border-radius: 8px;
  box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3); /* Â¢ûÂä†Èò¥ÂΩ±ÊïàÊûú */
  z-index: 10; /* Á°Æ‰øùÊåâÈíÆÈ´ò‰∫éÂÖ∂‰ªñÂÜÖÂÆπ */
  display: flex;
  flex-direction: column;
  align-items: center;
}

.function-btn,
.push-btn {
  margin-bottom: 10px;
  padding: 10px;
  background-color: #ffffff;
  color: black;
  border-radius: 50%;
  border: none;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
}

.add-btn {
  margin-bottom: 10px;
  padding: 10px;
  background-color: #ffffff;
  color: black;
  border-radius: 50%;
  border: none;
  font-size: 8px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
}

.push-btn {
  background-color: #4caf50;
}

.push-btn:hover {
  background-color: #45a049;
}

.function-btn:hover {
  background-color: #e6f0ff;
}

/* ÊåâÈíÆÂõæÊ†áÊ†∑Âºè */
.icon {
  width: 24px;
  height: 24px;
}

.icon:hover {
  transform: scale(1.2); /* Èº†Ê†áÊÇ¨ÊµÆÊó∂ÊîæÂ§ßÂõæÊ†á */
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 3; /* Êõ¥Êñ∞ z-index */
}

.popup-content {
  background: white;
  padding: 20px;
  width: 70%; /* ÂáèÂ∞èÂºπÁ™óÂÆΩÂ∫¶ */
  max-width: 350px; /* ËÆæÁΩÆÊúÄÂ§ßÂÆΩÂ∫¶ */
  border-radius: 8px;
  box-sizing: border-box;
}

.popup-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 10px;
}

.nickname {
  font-size: 16px;
  font-weight: bold;
  color: #333;
}

.popup-body {
  margin-bottom: 20px;
}

.popup-footer {
  margin-top: 20px;
  text-align: right;
}

.confirm-btn,
.cancel-btn {
  padding: 8px 15px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
}

.confirm-btn {
  background-color: #28a745;
  color: white;
  margin-right: 10px;
}

.cancel-btn {
  background-color: #dc3545;
  color: white;
  margin-right: 10px;
}

.confirm-btn:hover {
  background-color: #218838;
}

.cancel-btn:hover {
  background-color: #c82333;
}
</style>